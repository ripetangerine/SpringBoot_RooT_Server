<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>RooT API 테스트</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            color: #111827;
        }
        h1 { margin-bottom: 4px; }
        h2 { margin: 16px 0 8px; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .card {
            background: #ffffff;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
            color: #4b5563;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            outline: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
        }
        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
        }
        .row { margin-bottom: 8px; }
        .btn-row { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
        button {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            background: #2563eb;
            color: #ffffff;
        }
        button.secondary {
            background: #ffffff;
            color: #111827;
            border-color: #d1d5db;
        }
        button.danger {
            background: #dc2626;
        }
        button:disabled {
            opacity: 0.6;
            cursor: default;
        }
        .small {
            font-size: 12px;
            color: #6b7280;
        }
        .token-area textarea { min-height: 60px; }
        .status {
            font-size: 12px;
            margin-top: 4px;
        }
        .status.success { color: #16a34a; }
        .status.error { color: #dc2626; }
        code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background: #f3f4f6;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }
        .flex { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .flex input[type="text"] { flex: 1; }
    </style>
</head>
<body>
<div class="container">
    <h1>RooT API 테스트 페이지</h1>
    <div class="small">백엔드 기본 URL과 JWT / Refresh Token을 직접 보면서 API를 호출해 볼 수 있습니다.</div>

    <div class="card" style="margin-top:16px;">
        <h2>환경 설정</h2>
        <div class="row flex">
            <label for="baseUrl">Base URL</label>
            <input id="baseUrl" type="text" value="http://localhost:8080" />
            <button class="secondary" id="btnUseCurrentOrigin">현재 Origin 사용</button>
        </div>
        <div class="small">예: <code>http://localhost:8080</code></div>
    </div>

    <div class="grid">
        <div class="card">
            <h2>1. 회원가입 (/api/v1/auth/signup)</h2>
            <div class="row">
                <label for="signupEmail">Email</label>
                <input id="signupEmail" type="email" placeholder="test@example.com" />
            </div>
            <div class="row">
                <label for="signupPassword">Password</label>
                <input id="signupPassword" type="password" placeholder="비밀번호" />
            </div>
            <div class="row">
                <label for="signupName">Name</label>
                <input id="signupName" type="text" placeholder="이름" />
            </div>
            <div class="row">
                <label for="signupLang">Language</label>
                <input id="signupLang" type="text" value="ko" />
            </div>
            <div class="btn-row">
                <button id="btnSignup">회원가입 & 토큰 발급</button>
            </div>
            <div id="signupStatus" class="status"></div>
        </div>

        <div class="card">
            <h2>2. 로그인 (/api/v1/auth/login)</h2>
            <div class="row">
                <label for="loginEmail">Email</label>
                <input id="loginEmail" type="email" placeholder="test@example.com" />
            </div>
            <div class="row">
                <label for="loginPassword">Password</label>
                <input id="loginPassword" type="password" placeholder="비밀번호" />
            </div>
            <div class="btn-row">
                <button id="btnLogin">로그인</button>
            </div>
            <div id="loginStatus" class="status"></div>
        </div>
    </div>

    <div class="grid" style="margin-top:16px;">
        <div class="card token-area">
            <h2>토큰 관리</h2>
            <div class="row">
                <label for="accessToken">Access Token</label>
                <textarea id="accessToken" readonly></textarea>
            </div>
            <div class="row">
                <label for="refreshToken">Refresh Token</label>
                <textarea id="refreshToken" readonly></textarea>
            </div>
            <div class="btn-row">
                <button id="btnCopyAccess" class="secondary">Access 복사</button>
                <button id="btnCopyRefresh" class="secondary">Refresh 복사</button>
                <button id="btnClearTokens" class="danger">토큰 초기화</button>
            </div>
            <div id="tokenStatus" class="status"></div>
        </div>

        <div class="card">
            <h2>3. 토큰 재발급 (/api/v1/auth/refresh)</h2>
            <div class="small">현재 Refresh Token을 사용해 새로운 Access/Refresh Token을 발급합니다.</div>
            <div class="btn-row">
                <button id="btnRefresh">토큰 재발급</button>
            </div>
            <div id="refreshStatus" class="status"></div>
        </div>
    </div>

    <div class="grid" style="margin-top:16px;">
        <div class="card">
            <h2>4. 내 정보 조회 (/api/v1/user/me)</h2>
            <div class="small">Authorization 헤더에 Access Token을 넣어 호출합니다.</div>
            <div class="btn-row">
                <button id="btnGetMe">/api/v1/user/me 호출</button>
            </div>
            <div class="row">
                <label for="meResponse">Response</label>
                <textarea id="meResponse" readonly></textarea>
            </div>
            <div id="meStatus" class="status"></div>
        </div>
    </div>
</div>

<script>
    const $ = (id) => document.getElementById(id);

    const state = {
        accessToken: null,
        refreshToken: null
    };

    function setStatus(el, msg, ok) {
        el.textContent = msg || '';
        el.className = 'status ' + (ok == null ? '' : ok ? 'success' : 'error');
    }

    function updateTokenFields() {
        $('accessToken').value = state.accessToken || '';
        $('refreshToken').value = state.refreshToken || '';
    }

    function buildUrl(path) {
        const base = $('baseUrl').value.replace(/\/$/, '');
        return base + path;
    }

    async function apiCall(path, options = {}) {
        const url = buildUrl(path);
        const res = await fetch(url, options);
        const contentType = res.headers.get('content-type') || '';
        let body;
        try {
            body = contentType.includes('application/json') ? await res.json() : await res.text();
        } catch (e) {
            body = await res.text().catch(() => '');
        }
        return { status: res.status, ok: res.ok, body };
    }

    // Base URL: 현재 origin 사용 버튼
    $('btnUseCurrentOrigin').addEventListener('click', () => {
        $('baseUrl').value = window.location.origin;
    });

    // 회원가입
    $('btnSignup').addEventListener('click', async () => {
        setStatus($('signupStatus'), '요청 중...', null);
        const payload = {
            email: $('signupEmail').value,
            password: $('signupPassword').value,
            name: $('signupName').value,
            language: $('signupLang').value || 'ko'
        };

        try {
            const res = await apiCall('/api/v1/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                // TokenResponse: { accessToken, refreshToken, tokenType }
                state.accessToken = res.body.accessToken;
                state.refreshToken = res.body.refreshToken;
                updateTokenFields();
                setStatus($('signupStatus'), `회원가입 성공 (status ${res.status})`, true);
            } else {
                setStatus($('signupStatus'), `실패 (status ${res.status}): ${JSON.stringify(res.body)}`, false);
            }
        } catch (e) {
            setStatus($('signupStatus'), '에러: ' + e.message, false);
        }
    });

    // 로그인
    $('btnLogin').addEventListener('click', async () => {
        setStatus($('loginStatus'), '요청 중...', null);
        const payload = {
            email: $('loginEmail').value,
            password: $('loginPassword').value
        };

        try {
            const res = await apiCall('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                state.accessToken = res.body.accessToken;
                state.refreshToken = res.body.refreshToken;
                updateTokenFields();
                setStatus($('loginStatus'), `로그인 성공 (status ${res.status})`, true);
            } else {
                setStatus($('loginStatus'), `실패 (status ${res.status}): ${JSON.stringify(res.body)}`, false);
            }
        } catch (e) {
            setStatus($('loginStatus'), '에러: ' + e.message, false);
        }
    });

    // 토큰 복사
    $('btnCopyAccess').addEventListener('click', async () => {
        if (!state.accessToken) return;
        await navigator.clipboard.writeText(state.accessToken).catch(() => {});
        setStatus($('tokenStatus'), 'Access Token 복사됨', true);
    });

    $('btnCopyRefresh').addEventListener('click', async () => {
        if (!state.refreshToken) return;
        await navigator.clipboard.writeText(state.refreshToken).catch(() => {});
        setStatus($('tokenStatus'), 'Refresh Token 복사됨', true);
    });

    $('btnClearTokens').addEventListener('click', () => {
        state.accessToken = null;
        state.refreshToken = null;
        updateTokenFields();
        setStatus($('tokenStatus'), '토큰 초기화 완료', true);
    });

    // 토큰 재발급
    $('btnRefresh').addEventListener('click', async () => {
        if (!state.refreshToken) {
            setStatus($('refreshStatus'), 'Refresh Token이 없습니다.', false);
            return;
        }
        setStatus($('refreshStatus'), '요청 중...', null);
        const payload = { refreshToken: state.refreshToken };

        try {
            const res = await apiCall('/api/v1/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                state.accessToken = res.body.accessToken;
                state.refreshToken = res.body.refreshToken;
                updateTokenFields();
                setStatus($('refreshStatus'), `재발급 성공 (status ${res.status})`, true);
            } else {
                setStatus($('refreshStatus'), `실패 (status ${res.status}): ${JSON.stringify(res.body)}`, false);
            }
        } catch (e) {
            setStatus($('refreshStatus'), '에러: ' + e.message, false);
        }
    });

    // /me 호출
    $('btnGetMe').addEventListener('click', async () => {
        if (!state.accessToken) {
            setStatus($('meStatus'), 'Access Token이 없습니다.', false);
            return;
        }
        setStatus($('meStatus'), '요청 중...', null);

        try {
            const res = await apiCall('/api/v1/user/me', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + state.accessToken
                }
            });

            $('meResponse').value = typeof res.body === 'string' ? res.body : JSON.stringify(res.body, null, 2);
            setStatus($('meStatus'), `status ${res.status}`, res.ok);
        } catch (e) {
            setStatus($('meStatus'), '에러: ' + e.message, false);
        }
    });

    // 임의 요청
    $('btnSendCustom').addEventListener('click', async () => {
        const method = $('customMethod').value;
        const path = $('customPath').value || '/api/v1/auth/test';
        const useAuth = $('customUseAuth').checked;
        let bodyText = $('customBody').value.trim();

        setStatus($('customStatus'), '요청 중...', null);

        const headers = {};
        if (bodyText && method !== 'GET' && method !== 'DELETE') {
            headers['Content-Type'] = 'application/json';
        }
        if (useAuth && state.accessToken) {
            headers['Authorization'] = 'Bearer ' + state.accessToken;
        }

        let body;
        if (headers['Content-Type'] === 'application/json' && bodyText) {
            try {
                body = JSON.stringify(JSON.parse(bodyText));
            } catch (e) {
                setStatus($('customStatus'), 'Request Body JSON 파싱 오류: ' + e.message, false);
                return;
            }
        }

        try {
            const res = await apiCall(path, {
                method,
                headers,
                body
            });

            $('customResponse').value = typeof res.body === 'string' ? res.body : JSON.stringify(res.body, null, 2);
            setStatus($('customStatus'), `status ${res.status}`, res.ok);
        } catch (e) {
            setStatus($('customStatus'), '에러: ' + e.message, false);
        }
    });

    // 초기 토큰 영역 비우기
    updateTokenFields();
</script>
</body>
</html>

